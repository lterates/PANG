<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>PANG!</title>
    <link rel="stylesheet" type="text/css" href="pang.css">
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P&display=swap" rel="stylesheet">

</head>

<body>
    <div style="font-family:'Press Start 2P'; color:white; text-align: center;" id='container'>
        P A N G !
        <canvas id="myCanvas"></canvas>
    </div>

    <script>
        const canvas = document.querySelector('#myCanvas')
        const ctx = canvas.getContext('2d');

        let canvasW = 1000;
        let canvasH = 900;
        let buster;
        let style;
        let frameIndex = 0;
        let aceleration = 0.1
        let angle = -85 * Math.PI / 180;
        let keys = [];
        let balls = [];
        let lives = 3;
        let level = 1;

        document.addEventListener('DOMContentLoaded', SetupCanvas);

        function SetupCanvas() {
            canvas.width = canvasW
            canvas.height = canvasH
            //ctx.fillStyle = 'black'
            //ctx.fillRect (0, 0, canvas.width, canvas.height);
            background();
            buster = new Buster();
            buster2 = new Buster();
            ball = new Ball();
            harpoon = new Harpoon("orange");
            harpoon2 = new Harpoon("lightgreen");

            document.body.addEventListener("keydown", HandleKeyDown);
            document.body.addEventListener("keyup", HandleKeyUp);

            Render()
        }
        function HandleKeyDown(e){
            keys[e.keyCode] = true;
        }
        function HandleKeyUp(e){
            keys[e.keyCode] = false;
        }

        //BACKGROUND RENDER
        function background(){
            let img = new Image();
            img.src = 'night_sky.png';
            img.onload = function(){
                ctx.drawImage(img, 0, 0);
            }
        }

        // ~~~~~~~~~~~~~~~~~~~~ CLASSE DA PERSONAGEM ~~~~~~~~~~~~~~~~~~~~~~~~
        class Buster {
            constructor(){
                this.visible = true; 
                this.radius = 40;
                this.moveLeft = false;
                this.moveRight = false;
                this.x = (canvasW / 2) - this.radius;
                this.y = 700;
            }

            Update(){
            }
            
            Draw(){
                let spriteImg = new Image();
                spriteImg.src = "sprites.png";
                spriteImg.onload = function(){
                }
                
                ctx.drawImage(spriteImg, frameIndex*80,0,80,80,this.x ,this.y , 100, 170)
                
                frameIndex++;
                if(frameIndex == 9){
                    frameIndex = 0;
                }
            }
        }

        // ~~~~~~~~~~~~~~~~~~~~ CLASSE DAS BOLAS ~~~~~~~~~~~~~~~~~~~~~~~~
        class Ball{
            constructor(x, y, radius, level){
                this.visible = true;
                this.x = canvasW / 2;
                this.y = 300;
                this.radius = 50; 
                this.strokeColor = 'red';
                this.level = 1;
                this.velX = 8 * Math.cos(angle);
                this.velY = 8 * Math.sin(angle);
            }

            Update(){ 
            }

            Reset(){
                this.x = canvasW / 2;
                this.y = 300;
            }

            Draw(){
                ctx.beginPath()
                ctx.fillStyle = "#FF0000";
                ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
        }

        //~~~~~~~~~~~~~~~~~~~~ CLASSE DO HARPÃO ~~~~~~~~~~~~~~~~~~~~~~~~
        class Harpoon {
            constructor(style) {
                this.visible = true;
                this.x = buster.x + buster.radius;
                this.y = buster.y + buster.radius;
                this.shot = false;
                this.style = style;
            }

            Update(){
                
            }

            Draw(){
                ctx.beginPath()
                ctx.fillStyle = this.style;
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x, this.y - 50);
                ctx.lineTo(this.x + 10, this.y - 40);
                ctx.lineTo(this.x, this.y - 70);
                ctx.lineTo(this.x - 10, this.y - 40);
                ctx.lineTo(this.x, this.y - 50);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
        }

        function livesDraw(){
            let startX = 950;
            let startY = 10;
            ctx.strokeStyle = 'red';
            ctx.fillStyle = 'red';
            for(let i = 0; i < lives; i++){
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.rect(startX, startY, 15, 15)
                ctx.closePath();
                ctx.stroke();
                ctx.fill();
                startX -= 50;
            }
        }
        
        function floor(){
            ctx.strokeStyle = "black";
            ctx.fillStyle = "grey"
            ctx.beginPath();
            ctx.rect(0, 850, canvasW, 50)
            ctx.stroke();
            ctx.fill();
        }

        function Render() {
            //MOVIMENTO
            buster.moveLeft = (keys[65]);
            buster2.moveLeft = (keys[37]);
            buster.moveRight = (keys[68]);
            buster2.moveRight = (keys[39]);
            harpoon.shot = (keys[32])
            harpoon2.shot = (keys[87])
            let exit = keys[27];
            //BUSTER 1
            if (buster.moveLeft && buster.x !== 0) {
                buster.x -= 2
            }
            if (buster.moveRight && buster.x !== canvasW - 2 * buster.radius) {
                buster.x += 2
            }

            //HARPOONS
            if (harpoon.shot) {
                harpoon.y -= 5;
            }
            if (harpoon2.shot) {
                harpoon2.y -= 5;
            }
            harpoon.x = buster.x + buster.radius;
            harpoon2.x = buster2.x + buster.radius;
            //BUSTER 2
            if (buster2.moveLeft && buster2.x !== 0) {
                buster2.x -= 2
            }
            if (buster2.moveRight && buster2.x !== canvasW - 2 * buster2.radius) {
                buster2.x += 2
            }
            
            //BOLA
            ball.x += ball.velX;
            ball.y += ball.velY;

            if (ball.x == canvasW - ball.radius || ball.x == ball.radius){
                ball.velX *= -1
            }
            if (ball.y + ball.radius >= 850){
                ball.velY *= -1
            } else {
                ball.velY += aceleration;
            }

            //COLISÕES VÃO SER CHAMADAS AQUI
            if(harpoon.x + 5 <= ball.x + ball.radius 
                && harpoon.x - 5 >= ball.x - ball.radius
                && harpoon.y - 70 <= ball.y + ball.radius
                && harpoon.y - 70 >= ball.y - ball.radius){
                console.log("bang")
                harpoon.x = buster.x + buster.radius
                harpoon.y = buster.y + buster.radius
                ball.Reset();
            }
            
            background();
            livesDraw();
            floor();
            harpoon.Update();
            harpoon.Draw();
            harpoon2.Update();
            harpoon2.Draw();
            buster.Draw();
            buster2.Draw();
            ball.Update();
            ball.Draw();
            requestAnimationFrame(Render);
        }
    </script>
</body>
</html>